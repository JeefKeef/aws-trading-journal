"use client";

import { useState, useMemo } from "react";
import { useSearchParams, useRouter, usePathname } from "next/navigation";
import {
  Download,
  ChevronDown,
  X,
  Filter as FilterIcon,
} from "lucide-react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  AreaChart,
  Area,
  LineChart,
  Line,
} from "recharts";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils";
import { toast } from "sonner";

// Mock data
const mockTrades = [
  { date: "2025-10-05", ticker: "AAPL", pl: 680, volume: 100, strategy: "Breakout", status: "WIN" },
  { date: "2025-10-06", ticker: "TSLA", pl: -187, volume: 50, strategy: "Reversal", status: "LOSS" },
  { date: "2025-10-07", ticker: "MSFT", pl: 648, volume: 75, strategy: "Momentum", status: "WIN" },
  { date: "2025-10-08", ticker: "GOOGL", pl: 510, volume: 150, strategy: "Gap Fill", status: "WIN" },
  { date: "2025-10-09", ticker: "META", pl: -309, volume: 30, strategy: "Reversal", status: "LOSS" },
  { date: "2025-10-10", ticker: "AMZN", pl: 550, volume: 100, strategy: "Earnings Play", status: "WIN" },
  { date: "2025-10-11", ticker: "SPY", pl: -260, volume: 200, strategy: "Momentum", status: "LOSS" },
  { date: "2025-10-12", ticker: "QQQ", pl: 990, volume: 150, strategy: "Breakout", status: "WIN" },
  { date: "2025-10-13", ticker: "AMD", pl: -120, volume: 80, strategy: "Support/Resistance", status: "LOSS" },
  { date: "2025-10-14", ticker: "NVDA", pl: 780, volume: 25, strategy: "Gap Fill", status: "WIN" },
  { date: "2025-10-15", ticker: "AAPL", pl: 450, volume: 100, strategy: "Momentum", status: "WIN" },
  { date: "2025-10-16", ticker: "TSLA", pl: -95, volume: 50, strategy: "Breakout", status: "LOSS" },
  { date: "2025-10-17", ticker: "MSFT", pl: 320, volume: 75, strategy: "Breakout", status: "WIN" },
  { date: "2025-10-18", ticker: "GOOGL", pl: 890, volume: 150, strategy: "Momentum", status: "WIN" },
  { date: "2025-10-21", ticker: "META", pl: 420, volume: 30, strategy: "Gap Fill", status: "WIN" },
  { date: "2025-10-22", ticker: "AMZN", pl: -180, volume: 100, strategy: "Reversal", status: "LOSS" },
  { date: "2025-10-23", ticker: "SPY", pl: 275, volume: 200, strategy: "Momentum", status: "WIN" },
  { date: "2025-10-24", ticker: "QQQ", pl: 540, volume: 150, strategy: "Breakout", status: "WIN" },
  { date: "2025-10-25", ticker: "AMD", pl: -210, volume: 80, strategy: "Earnings Play", status: "LOSS" },
  { date: "2025-10-26", ticker: "NVDA", pl: 920, volume: 25, strategy: "Gap Fill", status: "WIN" },
  { date: "2025-10-27", ticker: "AAPL", pl: 380, volume: 100, strategy: "Momentum", status: "WIN" },
  { date: "2025-10-28", ticker: "TSLA", pl: 640, volume: 50, strategy: "Breakout", status: "WIN" },
  { date: "2025-10-29", ticker: "MSFT", pl: -145, volume: 75, strategy: "Reversal", status: "LOSS" },
  { date: "2025-10-30", ticker: "GOOGL", pl: 710, volume: 150, strategy: "Momentum", status: "WIN" },
  { date: "2025-10-31", ticker: "META", pl: 490, volume: 30, strategy: "Gap Fill", status: "WIN" },
  { date: "2025-11-01", ticker: "AMZN", pl: -95, volume: 100, strategy: "Support/Resistance", status: "LOSS" },
  { date: "2025-11-02", ticker: "SPY", pl: 330, volume: 200, strategy: "Momentum", status: "WIN" },
  { date: "2025-11-03", ticker: "QQQ", pl: 820, volume: 150, strategy: "Breakout", status: "WIN" },
  { date: "2025-11-04", ticker: "AMD", pl: 560, volume: 80, strategy: "Momentum", status: "WIN" },
];

type AnalyticsTab = "Overview" | "Detailed" | "Win vs Loss Days" | "Drawdown" | "Compare" | "Tag Breakdown" | "Advanced";

type FilterCategory = {
  name: string;
  options: string[];
};

const filters: FilterCategory[] = [
  { name: "Date Range", options: ["Last 7 Days", "Last 30 Days", "Last 90 Days", "This Month", "Last Month", "This Year", "All Time"] },
  { name: "Status", options: ["Any", "WIN", "LOSS", "BREAKEVEN"] },
  { name: "Strategy", options: ["Any", "Breakout", "Reversal", "Momentum", "Support/Resistance", "Gap Fill", "Earnings Play"] },
  { name: "P/L Range", options: ["Any", "Profitable", "Unprofitable", "Over $500", "Over $1000", "Under -$500"] },
  { name: "Ticker", options: ["Any", "AAPL", "TSLA", "MSFT", "GOOGL", "META", "AMZN", "SPY", "QQQ", "AMD", "NVDA"] },
];

export default function AnalyticsContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const pathname = usePathname();
  
  const activeTab = (searchParams.get("tab") as AnalyticsTab) || "Overview";
  const [selectedFilters, setSelectedFilters] = useState<Record<string, string>>({
    "Date Range": "Last 30 Days",
  });

  const setActiveTab = (tab: AnalyticsTab) => {
    const params = new URLSearchParams(searchParams.toString());
    params.set("tab", tab);
    router.push(`${pathname}?${params.toString()}`, { scroll: false });
  };

  // Calculate analytics data
  const analyticsData = useMemo(() => {
    // Daily P/L for last 30 days
    const last30Days = mockTrades.slice(-30);
    const dailyPL = last30Days.map((trade) => ({
      date: new Date(trade.date).toLocaleDateString("en-US", { month: "short", day: "numeric" }),
      pl: trade.pl,
    }));

    // Cumulative P/L
    const cumulativePL = last30Days.reduce((acc, trade, index) => {
      const prevTotal = index > 0 ? acc[index - 1].total : 0;
      acc.push({
        date: new Date(trade.date).toLocaleDateString("en-US", { month: "short", day: "numeric" }),
        total: prevTotal + trade.pl,
      });
      return acc;
    }, [] as Array<{ date: string; total: number }>);

    // Daily volume
    const dailyVolume = last30Days.map((trade) => ({
      date: new Date(trade.date).toLocaleDateString("en-US", { month: "short", day: "numeric" }),
      volume: trade.volume,
    }));

    // Win percentage by day
    const winsByDay = last30Days.reduce((acc, trade) => {
      const date = new Date(trade.date).toLocaleDateString("en-US", { month: "short", day: "numeric" });
      if (!acc[date]) {
        acc[date] = { wins: 0, total: 0 };
      }
      acc[date].total += 1;
      if (trade.status === "WIN") acc[date].wins += 1;
      return acc;
    }, {} as Record<string, { wins: number; total: number }>);

    const winPercentageData = Object.entries(winsByDay).map(([date, data]) => ({
      date,
      winRate: (data.wins / data.total) * 100,
    }));

    return { dailyPL, cumulativePL, dailyVolume, winPercentageData };
  }, []);

  const toggleFilter = (category: string, option: string) => {
    setSelectedFilters((prev) => ({
      ...prev,
      [category]: prev[category] === option ? "Any" : option,
    }));
  };

  const clearAllFilters = () => {
    setSelectedFilters({ "Date Range": "Last 30 Days" });
  };

  const activeFilterCount = Object.entries(selectedFilters).filter(
    ([key, v]) => v && v !== "Any" && key !== "Date Range"
  ).length;

  const exportData = () => {
    toast.success("Data exported", { description: "Analytics data downloaded as CSV" });
  };

  const tabs: AnalyticsTab[] = ["Overview", "Detailed", "Win vs Loss Days", "Drawdown", "Compare", "Tag Breakdown", "Advanced"];

  return (
    <div className="flex flex-col h-full bg-neutral-50 dark:bg-neutral-950">
      {/* Header with Tabs */}
      <div className="bg-white border-b border-neutral-200 dark:bg-neutral-900 dark:border-neutral-800 shrink-0">
        {/* Title and Export */}
        <div className="px-6 py-4 flex items-center justify-between border-b border-neutral-100 dark:border-neutral-800">
          <div>
            <h1 className="text-2xl font-bold text-neutral-900 dark:text-neutral-100">
              Analytics Dashboard
            </h1>
            <p className="text-sm text-neutral-500 dark:text-neutral-400 mt-1">
              Comprehensive performance analysis and insights
            </p>
          </div>
          <Button onClick={exportData} className="gap-2">
            <Download className="h-4 w-4" />
            Export Data
          </Button>
        </div>

        {/* Tabs Navigation */}
        <div className="px-6 py-0 border-b border-neutral-100 dark:border-neutral-800">
          <nav className="flex items-center gap-1 -mb-px">
            {tabs.map((tab) => {
              const isActive = activeTab === tab;
              return (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={cn(
                    "px-4 py-3 text-sm font-medium border-b-2 transition whitespace-nowrap",
                    isActive
                      ? "border-neutral-900 text-neutral-900 dark:border-neutral-100 dark:text-neutral-100"
                      : "border-transparent text-neutral-500 hover:text-neutral-700 hover:border-neutral-300 dark:text-neutral-400 dark:hover:text-neutral-300 dark:hover:border-neutral-600"
                  )}
                >
                  {tab}
                </button>
              );
            })}
          </nav>
        </div>

        {/* Filters Section */}
        <Accordion type="single" collapsible className="border-b border-neutral-200 dark:border-neutral-800">
          <AccordionItem value="filters" className="border-none">
            <AccordionTrigger className="px-6 py-3 text-sm font-semibold hover:no-underline hover:bg-neutral-50 dark:hover:bg-neutral-900/50">
              <div className="flex items-center gap-2">
                <FilterIcon className="h-4 w-4" />
                <span>Filters</span>
                {activeFilterCount > 0 && (
                  <span className="ml-2 px-2 py-0.5 text-xs font-medium bg-neutral-900 text-white dark:bg-neutral-100 dark:text-neutral-900 rounded-full">
                    {activeFilterCount}
                  </span>
                )}
              </div>
            </AccordionTrigger>
            <AccordionContent>
              <div className="px-6 py-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                {filters.map((filter) => (
                  <FilterDropdown
                    key={filter.name}
                    filter={filter}
                    selectedValue={selectedFilters[filter.name]}
                    onSelect={(option) => toggleFilter(filter.name, option)}
                  />
                ))}
              </div>

              {activeFilterCount > 0 && (
                <div className="px-6 py-2 bg-neutral-50 dark:bg-neutral-900 border-t border-neutral-100 dark:border-neutral-800">
                  <div className="flex items-center flex-wrap gap-2">
                    <span className="text-xs font-medium text-neutral-500 dark:text-neutral-400">
                      Active filters:
                    </span>
                    {Object.entries(selectedFilters).map(([category, value]) => {
                      if (!value || value === "Any" || category === "Date Range") return null;
                      return (
                        <button
                          key={category}
                          onClick={() => toggleFilter(category, value)}
                          className="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium bg-neutral-900 dark:bg-neutral-100 text-white dark:text-neutral-900 rounded-full hover:bg-neutral-800 dark:hover:bg-neutral-200 transition"
                        >
                          {category}: {value}
                          <X className="h-3 w-3" />
                        </button>
                      );
                    })}
                    <button
                      onClick={clearAllFilters}
                      className="text-xs font-medium text-neutral-500 hover:text-neutral-700 dark:text-neutral-400 dark:hover:text-neutral-300 underline"
                    >
                      Clear all
                    </button>
                  </div>
                </div>
              )}
            </AccordionContent>
          </AccordionItem>
        </Accordion>
      </div>

      {/* Tab Content */}
      <div className="flex-1 overflow-auto">
        {activeTab === "Overview" && <OverviewTab data={analyticsData} />}
        {activeTab === "Detailed" && <DetailedTab />}
        {activeTab === "Win vs Loss Days" && <WinLossDaysTab />}
        {activeTab === "Drawdown" && <DrawdownTab />}
        {activeTab === "Compare" && <CompareTab />}
        {activeTab === "Tag Breakdown" && <TagBreakdownTab />}
        {activeTab === "Advanced" && <AdvancedTab />}
      </div>
    </div>
  );
}

// Overview Tab Component
function OverviewTab({ data }: { 
  data: {
    dailyPL: Array<{ date: string; pl: number }>;
    cumulativePL: Array<{ date: string; total: number }>;
    dailyVolume: Array<{ date: string; volume: number }>;
    winPercentageData: Array<{ date: string; winRate: number }>;
  } 
}) {
  return (
    <div className="p-6">
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Gross Daily P&L */}
        <ChartCard title="GROSS DAILY P&L (30 Days)">
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={data.dailyPL}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis dataKey="date" tick={{ fontSize: 11 }} stroke="#6b7280" />
              <YAxis tick={{ fontSize: 11 }} stroke="#6b7280" />
              <Tooltip
                contentStyle={{
                  backgroundColor: "#fff",
                  border: "1px solid #e5e7eb",
                  borderRadius: "8px",
                  fontSize: "12px",
                }}
              />
              <Bar
                dataKey="pl"
                fill="#3b82f6"
                radius={[4, 4, 0, 0]}
              />
            </BarChart>
          </ResponsiveContainer>
        </ChartCard>

        {/* Gross Cumulative P&L */}
        <ChartCard title="GROSS CUMULATIVE P&L (30 Days)">
          <ResponsiveContainer width="100%" height={300}>
            <AreaChart data={data.cumulativePL}>
              <defs>
                <linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#10b981" stopOpacity={0.8} />
                  <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis dataKey="date" tick={{ fontSize: 11 }} stroke="#6b7280" />
              <YAxis tick={{ fontSize: 11 }} stroke="#6b7280" />
              <Tooltip
                contentStyle={{
                  backgroundColor: "#fff",
                  border: "1px solid #e5e7eb",
                  borderRadius: "8px",
                  fontSize: "12px",
                }}
              />
              <Area
                type="monotone"
                dataKey="total"
                stroke="#10b981"
                strokeWidth={2}
                fillOpacity={1}
                fill="url(#colorTotal)"
              />
            </AreaChart>
          </ResponsiveContainer>
        </ChartCard>

        {/* Daily Volume */}
        <ChartCard title="DAILY VOLUME (30 Days)">
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={data.dailyVolume}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis dataKey="date" tick={{ fontSize: 11 }} stroke="#6b7280" />
              <YAxis tick={{ fontSize: 11 }} stroke="#6b7280" />
              <Tooltip
                contentStyle={{
                  backgroundColor: "#fff",
                  border: "1px solid #e5e7eb",
                  borderRadius: "8px",
                  fontSize: "12px",
                }}
              />
              <Bar
                dataKey="volume"
                fill="#8b5cf6"
                radius={[4, 4, 0, 0]}
              />
            </BarChart>
          </ResponsiveContainer>
        </ChartCard>

        {/* Win % */}
        <ChartCard title="WIN % (30 Days)">
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={data.winPercentageData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis dataKey="date" tick={{ fontSize: 11 }} stroke="#6b7280" />
              <YAxis tick={{ fontSize: 11 }} stroke="#6b7280" domain={[0, 100]} />
              <Tooltip
                contentStyle={{
                  backgroundColor: "#fff",
                  border: "1px solid #e5e7eb",
                  borderRadius: "8px",
                  fontSize: "12px",
                }}
              />
              <Line
                type="monotone"
                dataKey="winRate"
                stroke="#f59e0b"
                strokeWidth={2}
                dot={{ r: 3 }}
              />
            </LineChart>
          </ResponsiveContainer>
        </ChartCard>
      </div>
    </div>
  );
}

// Placeholder tabs
function DetailedTab() {
  return (
    <div className="p-6">
      <div className="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-12 text-center">
        <h3 className="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">
          Detailed Analytics
        </h3>
        <p className="text-sm text-neutral-500 dark:text-neutral-400">
          Coming soon: In-depth trade analysis and metrics
        </p>
      </div>
    </div>
  );
}

function WinLossDaysTab() {
  return (
    <div className="p-6">
      <div className="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-12 text-center">
        <h3 className="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">
          Win vs Loss Days
        </h3>
        <p className="text-sm text-neutral-500 dark:text-neutral-400">
          Coming soon: Daily win/loss analysis and patterns
        </p>
      </div>
    </div>
  );
}

function DrawdownTab() {
  return (
    <div className="p-6">
      <div className="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-12 text-center">
        <h3 className="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">
          Drawdown Analysis
        </h3>
        <p className="text-sm text-neutral-500 dark:text-neutral-400">
          Coming soon: Maximum drawdown and recovery metrics
        </p>
      </div>
    </div>
  );
}

function CompareTab() {
  return (
    <div className="p-6">
      <div className="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-12 text-center">
        <h3 className="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">
          Compare Strategies
        </h3>
        <p className="text-sm text-neutral-500 dark:text-neutral-400">
          Coming soon: Side-by-side strategy comparison
        </p>
      </div>
    </div>
  );
}

function TagBreakdownTab() {
  return (
    <div className="p-6">
      <div className="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-12 text-center">
        <h3 className="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">
          Tag Breakdown
        </h3>
        <p className="text-sm text-neutral-500 dark:text-neutral-400">
          Coming soon: Performance by tags and categories
        </p>
      </div>
    </div>
  );
}

function AdvancedTab() {
  return (
    <div className="p-6">
      <div className="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-12 text-center">
        <h3 className="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">
          Advanced Analytics
        </h3>
        <p className="text-sm text-neutral-500 dark:text-neutral-400">
          Coming soon: Custom metrics and advanced statistics
        </p>
      </div>
    </div>
  );
}

function ChartCard({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <div className="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-lg p-4">
      <h3 className="text-xs font-semibold text-neutral-600 dark:text-neutral-400 uppercase tracking-wider mb-4">
        {title}
      </h3>
      {children}
    </div>
  );
}

function FilterDropdown({
  filter,
  selectedValue,
  onSelect,
}: {
  filter: FilterCategory;
  selectedValue?: string;
  onSelect: (option: string) => void;
}) {
  const [isOpen, setIsOpen] = useState(false);
  const [buttonRect, setButtonRect] = useState<DOMRect | null>(null);
  const displayValue = selectedValue && selectedValue !== "Any" ? selectedValue : filter.name;

  const handleButtonClick = (e: React.MouseEvent<HTMLButtonElement>) => {
    const rect = e.currentTarget.getBoundingClientRect();
    setButtonRect(rect);
    setIsOpen(!isOpen);
  };

  return (
    <>
      <div className="relative">
        <button
          onClick={handleButtonClick}
          className={cn(
            "w-full flex items-center justify-between px-3 py-2 text-xs font-medium rounded-lg border transition",
            selectedValue && selectedValue !== "Any"
              ? "bg-neutral-900 dark:bg-neutral-100 text-white dark:text-neutral-900 border-neutral-900 dark:border-neutral-100"
              : "bg-white dark:bg-neutral-900 text-neutral-700 dark:text-neutral-100 border-neutral-200 dark:border-neutral-700 hover:border-neutral-300 dark:hover:border-neutral-600"
          )}
        >
          <span className="truncate">{displayValue}</span>
          <ChevronDown
            className={cn(
              "h-3.5 w-3.5 ml-1 shrink-0 transition-transform",
              isOpen && "rotate-180"
            )}
          />
        </button>
      </div>

      {isOpen && buttonRect && (
        <>
          <div className="fixed inset-0 z-100" onClick={() => setIsOpen(false)} />
          <div
            className="fixed min-w-[200px] max-h-60 overflow-y-auto bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-lg shadow-xl z-100"
            style={{
              top: `${buttonRect.bottom + 4}px`,
              left: `${buttonRect.left}px`,
              width: `${buttonRect.width}px`,
            }}
          >
            {filter.options.map((option) => (
              <button
                key={option}
                onClick={() => {
                  onSelect(option);
                  setIsOpen(false);
                }}
                className={cn(
                  "w-full px-3 py-2 text-left text-xs hover:bg-neutral-50 dark:hover:bg-neutral-800 transition",
                  selectedValue === option && "bg-neutral-100 dark:bg-neutral-800 font-semibold"
                )}
              >
                {option}
              </button>
            ))}
          </div>
        </>
      )}
    </>
  );
}
